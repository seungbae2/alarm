---
description: 
globs: 
alwaysApply: false
---
## ğŸš€ â€œSingle-Activityâ€ Pill-Alarm App â€” ê°œë°œ ë¡œë“œë§µ (Clean Architecture)

> **ì „ì œ**
>
> * Kotlin Â· Jetpack Compose Â· Navigation-Compose
> * **MainActivity ë‹¨ 1ê°œ** + NavHost ë¼ìš°íŒ…
> * minSdk 21 / targetSdk 34
> * 2 ì£¼(10 ì‘ì—…ì¼) ìŠ¤í”„ë¦°íŠ¸ ê¸°ì¤€

---

### 1. í”„ë¡œì íŠ¸ ê³¨ê²© & ëª¨ë“ˆë§

| ìµœìƒìœ„ **ë ˆì´ì–´**      | í•˜ìœ„ ì„œë¸ŒíŒ¨í‚¤ì§€ ì˜ˆì‹œ            | ëŒ€í‘œ íŒŒì¼ Â· ì±…ì„                                                                                      |
| ----------------- | ---------------------- | ----------------------------------------------------------------------------------------------- |
| **presentation/** | `schedule/` Â· `alarm/` | Compose UI ìš”ì†Œ<br>â€¢ `ScheduleScreen.kt`<br>â€¢ `AlarmScreen.kt`<br>â€¢ ê°ê°ì˜ `â€¦ViewModel.kt`           |
| **domain/**       | `model/`               | `Alarm.kt`, `AlarmResult.kt`                                                                    |
|                   | `usecase/`             | `AddDailyNoonAlarmUseCase.kt`<br>`ObserveAlarmsByDateUseCase.kt`<br>`MarkAlarmResultUseCase.kt` |
|                   | `repository/`          | `AlarmRepository.kt` (interface)                                                                |
| **data/**         | `local/db/`            | `AlarmDatabase.kt`, `AlarmDao.kt`, `AlarmEntity.kt`                                             |
|                   | `scheduler/`           | `AlarmScheduler.kt`, `AlarmSchedulerImpl.kt`                                                    |
|                   | `service/`             | `ForegroundAlarmService.kt`                                                                     |
|                   | `receiver/`            | `ExactAlarmReceiver.kt`, `BootReceiver.kt`                                                      |
|                   | `repository/`          | `AlarmRepositoryImpl.kt` (Room + AlarmScheduler)                                                |
| **navigation/**   | â€”                      | `AppNavGraph.kt` (NavHostÂ·ë”¥ë§í¬)                                                                  |
| **di/**           | â€”                      | Hilt ëª¨ë“ˆ<br>â€¢ `AppModule.kt` (Singleton ì œê³µ)<br>â€¢ `DataModule.kt`, `DomainModule.kt`              |
| **designsystem/** | â€”                      | Material 3 í…Œë§ˆÂ·ìƒ‰ìƒÂ·íƒ€ì´í¬ê·¸ë˜í”¼                                                                         |
| **util/**         | â€”                      | `DateTimeExt.kt`, `WindowFlagHelper.kt`, `PermissionHelper.kt`                                  |
| **testutil/**     | `fake/`                | `FakeAlarmRepository.kt`, `CoroutineTestRule.kt`                                                |


> **DI**: Hilt + Hilt Navigation Compose.

---

### 2. ë°ì´í„° ëª¨ë¸ & ì €ì¥ì†Œ

```kotlin
@Entity(tableName = "alarm_schedules")
data class AlarmEntity(
    @PrimaryKey(autoGenerate = true) val id: Long = 0,
    val hour: Int,
    val minute: Int,
    val createdAt: Instant,
    val result: AlarmResult? = null           // TAKEN Â· SKIPPED Â· null
)
```

* **Room** + `Flow<List<AlarmEntity>>`
* **AlarmRepository** ì¸í„°í˜ì´ìŠ¤ â†” `AlarmRepositoryImpl`(data-alarm)
* ì •í™•í•œ ì•ŒëŒ ê¶Œí•œ ì²´í¬ í—¬í¼ (`ExactAlarmPermissionChecker`).

---

### 3. Domain â€” ìœ ìŠ¤ì¼€ì´ìŠ¤

| Use-case                           | ì„¤ëª…                                   |
| ---------------------------------- | ------------------------------------ |
| `AddDailyNoonAlarm()`              | ì¤‘ë³µ ì—¬ë¶€ í™•ì¸ í›„ DB ì‚½ì… â†’ AlarmScheduler ì˜ˆì•½ |
| `ObserveAlarmsByDate(date)`        | ë‚ ì§œ í•„í„°ë§ Flow ìŠ¤íŠ¸ë¦¼                      |
| `MarkAlarmResult(alarmId, result)` | result ì €ì¥, í¬ê·¸ë¼ìš´ë“œ ì„œë¹„ìŠ¤ stop            |
| `Re-scheduleAllActiveAlarms()`     | BOOT\_COMPLETEÂ·ê¶Œí•œ ë³€ê²½Â·íƒ€ì„ì¡´ ë³€ê²½ ì‹œ í˜¸ì¶œ     |

---

### 4. ì‹œìŠ¤í…œ í†µí•© íŒ¨í„´ (Single-Activity íŠ¹í™”)

| êµ¬ì„±ìš”ì†Œ                       | ì—­í•                                                                                        |
| -------------------------- | ---------------------------------------------------------------------------------------- |
| **AlarmScheduler**         | `AlarmManager.setExactAndAllowWhileIdle()` <br>â†’ `PendingIntent.getActivity(...)` (ë”¥ë§í¬)  |
| **ForegroundAlarmService** | `startForeground()` + `NotificationCompat`<br>`setFullScreenIntent(pendingIntent, true)` |
| **MainActivity**           | Manifest `singleTask` + NavHost, deep-link scheme `pillalarm://alarm?id={id}`            |
| **BootReceiver**           | ì¬ë¶€íŒ… ì‹œ `WorkManager`ë¡œ ì¬ì˜ˆì•½                                                                 |
| **Window Flag Helper**     | `showWhenLocked` Â· `turnScreenOn` í† ê¸€ í•¨ìˆ˜ (AlarmScreen ìƒëª…ì£¼ê¸°ì—ë§Œ ì ìš©)                          |

---

### 5. Navigation êµ¬ì„±

```kotlin
NavHost(navController, startDestination = "schedule") {
    composable("schedule") { ScheduleScreen() }

    composable(
        route = "alarm/{id}",
        arguments = listOf(navArgument("id") { type = NavType.LongType }),
        deepLinks = listOf(navDeepLink { uriPattern = "pillalarm://alarm?id={id}" })
    ) { entry ->
        AlarmScreen(
            alarmId = entry.arguments!!.getLong("id"),
            onResult = { result ->
                vm.mark(alarmId, result)
                navController.popBackStack("schedule", inclusive = false)
            }
        )
    }
}
```

* ë’¤ë¡œê°€ê¸° ì „ë©´ ì°¨ë‹¨: `BackHandler(enabled = true) {}`
* ì§„ì… ì‹œ `WindowFlagHelper.enableAlarmFlags()` â€” `DisposableEffect`ë¡œ í•´ì œ.

---

### 6. UI ë ˆì´ì–´

| Screen             | Compose êµ¬ì„± í¬ì¸íŠ¸                                                                                                       |
| ------------------ | -------------------------------------------------------------------------------------------------------------------- |
| **ScheduleScreen** | `Scaffold` topBar = WeekPagerRow (Accompanist Pager) <br>`LazyColumn` ì•ŒëŒ í–‰ ë¦¬ìŠ¤íŠ¸ <br>FAB â†’ `AddDailyNoonAlarm()`       |
| **AlarmScreen**    | ì¤‘ì•™ ì‹œê³„ + ë‘ ë²„íŠ¼ <br>í¬ê·¸ë¼ìš´ë“œ ìƒ‰ ëŒ€ë¹„ ê°•í™” (Material3 `dynamicColor=false`) <br>`Text(clock)` ì€ `rememberTicker` Flow ë¡œ 1-ì´ˆ ì—…ë°ì´íŠ¸ |

---

### 7. í…ŒìŠ¤íŠ¸ ê³„ì¸µ

| ë ˆë²¨           | ë„êµ¬                            | ì‹œë‚˜ë¦¬ì˜¤                                    |
| ------------ | ----------------------------- | --------------------------------------- |
| Domain       | JUnit5 + Turbine              | ì¤‘ë³µ ì•ŒëŒ ê±°ì ˆ, ê²°ê³¼ ê¸°ë¡                         |
| Data         | Robolectric                   | AlarmManager ì˜ˆì•½ ì‹œê°„ ê²€ì¦, BootReceiver     |
| Presentation | Compose UI í…ŒìŠ¤íŠ¸                | WeekPager swipe, FAB ë™ì‘, AlarmScreen ë²„íŠ¼ |
| E2E          | Espresso + AlarmManagerShadow | ê°€ìƒ ì‹œê³„ë¡œ ì•ŒëŒ íŠ¸ë¦¬ê±° â†’ í™”ë©´ ê°•ì œ ë…¸ì¶œ í™•ì¸             |

---

### 8. ì¼ì • (T-10 â†’ T-0)

| Day           | ì‘ì—… ë¸”ë¡                                                   |
| ------------- | ------------------------------------------------------- |
| **T-10 \~ 9** | í”„ë¡œì íŠ¸ & ëª¨ë“ˆ ìŠ¤ìºí´ë”©, MainActivity + NavHost ê³¨ê²©               |
| **T-8 \~ 7**  | Room ìŠ¤í‚¤ë§ˆ, Repository/Use-case, ë‹¨ìœ„ í…ŒìŠ¤íŠ¸                   |
| **T-6**       | AlarmScheduler, ForegroundAlarmService, Notification ì±„ë„ |
| **T-5**       | AlarmScreen UI + WindowFlagHelper + ë”¥ë§í¬ ì—°ê²°              |
| **T-4**       | ScheduleScreen UI, WeekPagerRow, FAB ë™ì‘                 |
| **T-3**       | BootReceiver + WorkManager ì¬ì˜ˆì•½, ê¶Œí•œ í—¬í¼                   |
| **T-2**       | í†µí•© í…ŒìŠ¤íŠ¸, ì—ì§€ì¼€ì´ìŠ¤(DozeÂ·DNDÂ·ìµœê·¼ì•± ì¢…ë£Œ)                          |
| **T-1**       | ë””ìì¸ ë§ˆê°, ì ‘ê·¼ì„±Â·ë‹¤í¬ëª¨ë“œ ì ê²€, proguard ì„¤ì •                        |
| **T-0**       | READMEÂ·ìŠ¤í¬ë¦°ìƒ· ì‘ì„± â†’ APK & ì†ŒìŠ¤ íŒ¨í‚¤ì§•                           |

---

### 9. ë°°í¬ & ì œì¶œ ì²´í¬ë¦¬ìŠ¤íŠ¸

* `SCHEDULE_EXACT_ALARM` ê¶Œí•œ ì•ˆë‚´ UI í¬í•¨ ì—¬ë¶€
* targetSdk 34 â†’ `foregroundServiceType="alarm"` ì„ ì–¸
* QA: ì ê¸ˆë²„íŠ¼Â·ìµœê·¼ì•± ìŠ¤ì™€ì´í”„ í›„ **5 ì´ˆ ë‚´ ì¬ë“±ì¥** í™•ì¸
* `./gradlew assembleRelease` â†’ `pill-alarm-release.apk`
* Git repo: `./gradlew test`Â·`connectedCheck` í†µê³¼ ë¡œê·¸ ì²¨ë¶€

---

**â¡ï¸ ì´ ë¡œë“œë§µì„ ë”°ë¼ê°€ë©´**

* MainActivity í•˜ë‚˜ë¡œ **ë°±ìŠ¤íƒÂ·í”Œë˜ê·¸ ê´€ë¦¬ê°€ ë‹¨ì¼í™”**ë˜ì–´ ìœ ì§€ë³´ìˆ˜ì„±ì´ ë†’ì•„ì§‘ë‹ˆë‹¤.
* Foreground Service + fullScreenIntent ì¡°í•©ìœ¼ë¡œ **ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰ ì œì•½**ë„ í†µê³¼í•©ë‹ˆë‹¤.
* Clean Architecture ëª¨ë“ˆë§ ë•ë¶„ì— í…ŒìŠ¤íŠ¸Â·ê¸°ëŠ¥ í™•ì¥(ë‹¤ì¤‘ ì‹œê°„Â·ë°˜ë³µ ì£¼ê¸°) ì—­ì‹œ ìˆ˜ì›”í•©ë‹ˆë‹¤.

